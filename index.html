<!DOCTYPE html>
<html>
<body>


<!-- <div>
	<button onclick="getLatestBlock()" >Get Latest Block </button>
	<div id='blockResponse'></div>
</div>

<br/><br/> -->

<!-- <div>
	<input id='account' value='5555a83349295167' placeholder="Enter Flow address">
	<button onclick="getAccount()" >Lookup Account </button>
	<div id='getAccounResponse'></div>
</div>

<br/><br/> -->

<!-- 
<div>
	<textarea id='script'>
		pub fun main(): Int {
 			 return 42 + 6
		}
	</textarea>
	<button onclick="runScript()" >Run Script</button>
	<div id='runScriptResponse'></div>
</div> -->


<br/><br/>


<div>
	
	<button onclick="window.fcl.authenticate()" >Login</button>
	<button onclick="window.fcl.unauthenticate()" >Logout</button>

	<div id='loginResponse'></div>
</div>


<br/><br/>

<div>
  <h2>Transfer GeniaceNFT - Testnet</h2>
  <!-- 0x54736a7d074d7816 -->
	RECIPIENT ADDRESS:<input type="text" id="recipient" name="address"><br>
  TOKEN ID:<input type="text" id="tokenId" name="tokenId"><br>
	<button onclick="sendGeniaceNFT()" >Send Transaction</button>
	<div id='sendTransactionResponse'></div>
</div>


<div>
  <h2>Get geni balance - Testnet</h2>
	<button onclick="getGeniBalance()" >Get Geni Balance</button><br>>
	<div id='geniBalance'></div>
</div>

<div>
  <h2>Transfer Geni - Testnet</h2>
  RECIPIENT ADDRESS: <input type="text" id="geniRecipient" name="address">
  AMOUNT: <input type="text" id="geniAmount" name="amount">
	<button onclick="transferGeni()" >Transfer Geni</button><br>
	<div id='geniTransactionResponse'></div>
</div>


<script src="fcl.js"></script>
<script src="https://unpkg.com/@onflow/types@0.0.5/dist/types.umd.js"></script>

<script>
window.fcl.config()
  .put("accessNode.api", "https://access-testnet.onflow.org")
  .put("challenge.handshake", "https://flow-wallet-testnet.blocto.app/authn") 

const transferGeniaceNFTTransactionScript = `
import NonFungibleToken from 0x631e88ae7f1d7c20
import GeniaceNFT from 0x99eb28310626e56a

// This transaction transfers a Geniace NFT from one account to another.

transaction(recipient: Address, withdrawID: UInt64) {
    prepare(signer: AuthAccount) {
        
        // get the recipients public account object
        let recipient = getAccount(recipient)

        // borrow a reference to the signer's NFT collection
        let collectionRef = signer.borrow<&GeniaceNFT.Collection>(from: GeniaceNFT.CollectionStoragePath)
            ?? panic("Could not borrow a reference to the owner's collection")

        // borrow a public reference to the receivers collection
        let depositRef = recipient.getCapability(GeniaceNFT.CollectionPublicPath)!.borrow<&{NonFungibleToken.CollectionPublic}>()!

        // withdraw the NFT from the owner's collection
        let nft <- collectionRef.withdraw(withdrawID: withdrawID)

        // Deposit the NFT in the recipient's collection
        depositRef.deposit(token: <-nft)
    }
}

`

const getGeniBalanceScript = `
import Geni from 0x85d301aec51787de
import FungibleToken from 0x9a0766d93b6608b7

// This script returns an account's Geni balance.

pub fun main(address: Address): UFix64 {
    let account = getAccount(address)
    
    let vaultRef = account.getCapability(Geni.BalancePublicPath)!.borrow<&Geni.Vault{FungibleToken.Balance}>()
        ?? panic("Could not borrow Balance reference to the Vault")

    return vaultRef.balance
}
`

const transferGeniTransactionScript = `
import FungibleToken from 0x9a0766d93b6608b7
import Geni from 0x85d301aec51787de

// This transaction is a template for a transaction that
// could be used by anyone to send tokens to another account
// that has been set up to receive tokens.
//
// The withdraw amount and the account from getAccount
// would be the parameters to the transaction

transaction(amount: UFix64, to: Address) {

    // The Vault resource that holds the tokens that are being transferred
    let sentVault: @FungibleToken.Vault

    prepare(signer: AuthAccount) {

        // Get a reference to the signer's stored vault
        let vaultRef = signer.borrow<&Geni.Vault>(from: Geni.VaultStoragePath)
			?? panic("Could not borrow reference to the owner's Vault!")

        // Withdraw tokens from the signer's stored vault
        self.sentVault <- vaultRef.withdraw(amount: amount)
    }

    execute {

        // Get the recipient's public account object
        let recipient = getAccount(to)

        // Get a reference to the recipient's Receiver
        let receiverRef = recipient.getCapability(Geni.ReceiverPublicPath)!.borrow<&{FungibleToken.Receiver}>()
			?? panic("Could not borrow receiver reference to the recipient's Vault")

        // Deposit the withdrawn tokens in the recipient's receiver
        receiverRef.deposit(from: <-self.sentVault)
    }
}

`

var userAddrss = '';

window.fcl.currentUser().subscribe(user => showUser({...user}))

var showUser = function(user){
	console.log(user);
      userAddrss = user.addr
	    document.getElementById('loginResponse').innerText = JSON.stringify(user);
}
var getLatestBlock = async function() {
    const response = await window.fcl.send([
      window.fcl.getLatestBlock(),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('blockResponse').innerText = JSON.stringify(r);
}

var getAccount = async function() {
    const response = await window.fcl.send([
      window.fcl.getAccount(document.getElementById('account').value),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('getAccounResponse').innerText = JSON.stringify(r);
}

var runScript = async function() {
    const response = await window.fcl.send([
      window.fcl.script(document.getElementById('script').value),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('runScriptResponse').innerText = JSON.stringify(r);
}

var setStatus = function(status, id){
    document.getElementById(id).innerText = status;
}

var getGeniBalance = async function() {
  try{
    const response = await window.fcl.send([
      window.fcl.script(getGeniBalanceScript),
      window.fcl.args([
          window.fcl.arg(userAddrss, window.types.Address),
        ])
    ]);
    var r  = await window.fcl.decode(response);

    document.getElementById('geniBalance').innerText = JSON.stringify(r);

  } catch(err){
    document.getElementById('geniBalance').innerText = "0";
  }
    
}

var transferGeni = async function() {
    // const response = await window.fcl.send([
    //   window.fcl.script(document.getElementById('script').value),
    // ]);

    setStatus("Resolving...", "geniTransactionResponse")

    const blockResponse = await window.fcl.send([
      window.fcl.getLatestBlock(),
    ])

    const block = await window.fcl.decode(blockResponse)

    try {
      const { transactionId } = await window.fcl.send([
        window.fcl.transaction(transferGeniTransactionScript),
        window.fcl.args([
          window.fcl.arg(document.getElementById('geniRecipient').value.trim(), window.types.Address),
          window.fcl.arg(parseInt(parseFloat(document.getElementById('geniAmount').value).toFixed(2)), window.types.UFix64),
        ]),
        window.fcl.proposer(window.fcl.currentUser().authorization),
        window.fcl.authorizations([window.fcl.currentUser().authorization]),
        window.fcl.payer(window.fcl.currentUser().authorization),
        window.fcl.ref(block.id),
        window.fcl.limit(9999),
          ])

      setStatus("Transaction sent, waiting for confirmation", "geniTransactionResponse")

      const unsub = fcl
        .tx({ transactionId })
        .subscribe(transaction => {

          if (window.fcl.tx.isSealed(transaction)) {
            console.log("Transaction:",transaction);
            setStatus("Transaction is Sealed", "geniTransactionResponse")
            unsub()
          }
        })
    } catch (error) {
      console.error(error);
      setStatus("Transaction failed", "geniTransactionResponse")
    }
 }


var sendGeniaceNFT = async function() {
    // const response = await window.fcl.send([
    //   window.fcl.script(document.getElementById('script').value),
    // ]);
    console.log("recepient:",document.getElementById('recipient').value);
    console.log("token Id:",document.getElementById('tokenId').value);

    setStatus("Resolving...", "sendTransactionResponse")

    const blockResponse = await window.fcl.send([
      window.fcl.getLatestBlock(),
    ])

    const block = await window.fcl.decode(blockResponse)

    try {
      const { transactionId } = await window.fcl.send([
        window.fcl.transaction(transferGeniaceNFTTransactionScript),
        window.fcl.args([
          window.fcl.arg(document.getElementById('recipient').value.trim(), window.types.Address),
          window.fcl.arg(parseInt(document.getElementById('tokenId').value), window.types.UInt64),
        ]),
        window.fcl.proposer(window.fcl.currentUser().authorization),
        window.fcl.authorizations([window.fcl.currentUser().authorization]),
        window.fcl.payer(window.fcl.currentUser().authorization),
        window.fcl.ref(block.id),
        window.fcl.limit(9999),
          ])

      setStatus("Transaction sent, waiting for confirmation", "sendTransactionResponse")

      const unsub = fcl
        .tx({ transactionId })
        .subscribe(transaction => {

          if (window.fcl.tx.isSealed(transaction)) {
            console.log("Transaction:",transaction);
            setStatus("Transaction is Sealed", "sendTransactionResponse")
            unsub()
          }
        })
    } catch (error) {
      console.error(error);
      setStatus("Transaction failed", "sendTransactionResponse")
    }
 }


</script>

</body>
</html> 
